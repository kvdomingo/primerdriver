version: 2.1

orbs:
    python: circleci/python@0.2.1
    heroku: circleci/heroku@0.0.10
    percy: percy/agent@0.1.2

jobs:
    build-and-test:
        working_directory: ~/app
        docker:
            - image: circleci/python:3.7.8-node-browsers
        steps:
            - checkout
            - run:
                command: npm i
                name: Install Node.js dependencies
            - run: sudo chown -R circleci:circleci /usr/local/bin
            - run: sudo chown -R circleci:circleci /usr/local/lib/python3.7/site-packages
            - restore_cache:
                  key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
            - run:
                command: |
                      sudo pip install pipenv
                      pipenv install
                name: Install Python dependencies
            - save_cache:
                  key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
                  paths:
                      - "/usr/local/bin"
                      - "/usr/local/lib/python3.7/site-packages"
            - run:
                command: pipenv run python -m coverage run --source='.' manage.py test
                name: Run test and generate coverage report
            - run:
                command: pipenv run python -m codecov
                name: Upload coverage report

workflows:
    main:
        jobs:
            - build-and-test
            - percy/finalize_all:
                requires:
                    - build-and-test
            - heroku/deploy-via-git:
                requires:
                    - build-and-test
                    - percy/finalize_all
                filters:
                    branches:
                        only: master
