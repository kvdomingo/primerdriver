version: 2.1

orbs:
    python: circleci/python@0.2.1
    heroku: circleci/heroku@0.0.10
    browser-tools: circleci/browser-tools@1.0.0
    percy: percy/agent@0.1.2

jobs:
    build-and-test:
        executor: python/default
        steps:
            - checkout
            - python/load-cache
            - python/install-deps
            - python/save-cache
            - run:
                command: nohup python manage.py runserver 127.0.0.1:8000 &
                name: Start development server
            - browser-tools/install-firefox
            - browser-tools/install-geckodriver
            - run:
                command: python manage.py test
                name: Test
            - run:
                command: python -m coverage run --source='.' manage.py test
                name: Coverage
            - run:
                command: python -m codecov
                name: Upload coverage report

workflows:
    heroku_deploy:
        jobs:
            - build-and-test
            - percy/finalize_all:
                requires:
                    - build-and-test
            - heroku/deploy-via-git:
                requires:
                    - build-and-test
                    - percy/finalize_all
                filters:
                    branches:
                        only: master
