version: 2.1

orbs:
    python: circleci/python@0.2.1
    heroku: circleci/heroku@0.0.10
    browser-tools: circleci/browser-tools@1.0.0
    percy: percy/agent@0.1.2

jobs:
    build-and-test:
        docker:
            - image: cimg/base:2020.01
        steps:
            - checkout
            - run:
                command: sudo apt-get install python3.6.8
                name: Install Python
            - run:
                command: python3 -m pip install -U pip
                name: Install Python package manager
            - python/load-cache
            - python/install-deps
            - python/save-cache
            - browser-tools/install-firefox
            - browser-tools/install-geckodriver
            - run:
                command: python3 manage.py test
                name: Test
            - run:
                command: python3 -m coverage run --source='.' manage.py test
                name: Coverage
            - run:
                command: python3 -m codecov
                name: Upload coverage report

workflows:
    main:
        jobs:
            - build-and-test
            - percy/finalize_all:
                requires:
                    - build-and-test
            - heroku/deploy-via-git:
                requires:
                    - build-and-test
                    - percy/finalize_all
                filters:
                    branches:
                        only: master
